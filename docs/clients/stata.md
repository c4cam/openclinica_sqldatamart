# Stata Clients


## Summary
- [Ad-hoc](#ad-hoc)
- [Study Snapshots](#study-snapshots)


## Ad-hoc
The following command creates an ODBC connection to OCDM and copies the 
contents of the *subjects* materialized view for *myStudyName* (insert File 
DSN reference string, or ODBC connection string):

```stata
odbc load, table("myStudyNameSchemaName.subjects") noquote \\\ 
  connectionstring("fileDSN reference string, or ODBC connection string")
```

These commands can be generated using the snapshot script (see below).


## Study Snapshots
In the "clients" folder, a Stata Do script "snapshot_stata.do" is included to 
facilitate saving a snapshot of study data as Stata .dta files. The script 
connects to datamart, calls a function which prepares Stata commands, saves the 
commands in a Do file, and runs the generated Do file.

Refer to the script header comment for a description of the required parameters.
If desired, the generated Do file execution can be commented out so that the 
script can be reviewed or edited before running the export.

The Stata code generated by the function includes commands that:

 - Load each item group data set in memory,
 - Label each variable using the item_description,
 - Label variable values, where the item data type is INT and the item has a 
   response label set defined,
 - Set the display format for string variables to %20s for easier viewing,
 - Load the following metadata data sets: 'subjects', 'subject_groups', 
   'metadata_event_crf_ig', 'metadata_crf_ig_item', 'response_set_labels', 
   'timestamp_data', 'timestamp_schema'.
 - Save each loaded data set as a Stata DTA file.

During generation of the labelling commands, the following changes are made to 
label strings so that the generated commands are valid:

  - Replace double quote characters with single quotes,
  - Replace newline / line return characters with a space.


### Site XLSX Extension
At the end of a study, it is often required to provide participating 
institutions with a copy of the data that they had submitted for the study, 
ideally in an easily readable format.

In order to facilitate this, an extension to the above Stata snapshot code has 
been developed. Each of the study item group data sets is exported to Excel 
XLSX, filtered for that site. Study metadata and subject listings are also 
included.

The extension script "snapshot_stata_site_xlsx_extension.do" is filed in the 
"clients" folder with the main script. As described in the comments, the 
procedure is to:
- Run the main script to generate (but not run) the snapshot code, 
- Perform a simple find/replace, 
- Insert the extension code (and update the study schema name therein),
- Run the modified snapshot code script.

The Excel files will be saved in folders named according to the site oid.

At some stage this functionality may be incorporated into the main snapshot  
script, so that this site export mode can be invoked from the main script 
by providing parameter / flag.


## Stata 14 Issue
A minor issue with Stata 14 and ODBC data was noted. Some columns, in 
particular the "event_name" column, are intepreted by Stata 14 as the new 
"strL" data type in binary format. During loading, a bug causes the column 
values include the original value as well as some content from adjacent columns.

This issue is resolved in Stata 14.1, which is a free update to Stata 14.
